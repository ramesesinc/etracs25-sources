import com.rameses.annotations.*;

class PoliceClearanceApplicationPersistenceInterceptor {
	
	@DataContext('mayorclearance') 
	def mcdb;

	@DataContext('policeclearance') 
	def pcdb;

	@Service("SequenceService")
	def seqSvc;

	@Service("DateService")
	def dateSvc;

	@Service('EntityService')
	def entitySvc; 

	@DataContext('entity_photo') 
	def photodb;

	@DataContext('entity_fingerprint') 
	def fingerprintdb;

	@DataContext('policeclearance_application') 
	def appdb; 


	@Before(pattern="PersistenceService.create", eval="#{args[0]._schemaname == 'policeclearance_application'}")
	public void beforeCreate( evt ) {
		def v  = evt.args[0];
		def appno = seqSvc.getNextControlNo( "P[ORG][yyyyMM]%05d", []); 
		if ( appno ) v.appno = appno.replaceAll("-",""); 

		v.appdate = dateSvc.getBasicServerDate(); 
		v.state = 'ACTIVE'; 

		v._photo = v.remove('photo'); 
		v._fingerprint = v.remove('fingerprint'); 
	}

	@After(pattern="PersistenceService.create", eval="#{args[0]._schemaname == 'policeclearance_application'}")
	public void afterCreate( evt ) {
		def arg = evt.args[0];
		def result = evt.result; 
		def photo = arg.remove('_photo'); 
		if ( photo?.image ) {
			photo.objid = 'EPH'+ new java.rmi.server.UID(); 
			photo.entityid = result.applicant.objid; 
			photo.dtfiled = result.dtcreated; 
			photo.createdby = result.createdby; 
			photodb.create( photo ); 
		}

		def fp = arg.remove('_fingerprint');
		if ( fp?.image ) {
			fp.objid = 'EFP'+ new java.rmi.server.UID(); 
			fp.entityid = result.applicant.objid; 
			fp.dtfiled = result.dtcreated; 
			fp.fingertype = fp.type; 
			fingerprintdb.create( fp ); 
		} 

		def upd = [:]; 
		upd.photo = photo; 
		upd.fingerprint = fp; 
		appdb.find([ objid: result.objid ]).update( upd );  
	}

	@After(pattern="PersistenceService.(create|read)", eval="#{args[0]._schemaname == 'policeclearance_application'}")
	public void loadDefaultInfo( evt ) {
		def r = evt.result;
		r.barcode = '51011:'+ r.appno;
	}

	@After(pattern="PersistenceService.read", eval="#{args[0]._schemaname == 'policeclearance_application'}")
	public void afterOpen( evt ) {
		def result = evt.result;

		def applicant = entitySvc.open([ objid: result.applicant?.objid ]); 
		if ( applicant ) result.applicant = applicant; 

		if ( result.photo?.objid ) {
			result.photo = photodb.find([ objid: result.photo.objid ])
								  .select('objid,dtfiled,image')
								  .first(); 
		}
		if ( result.fingerprint?.objid ) {
			result.fingerprint = fingerprintdb.find([ objid: result.fingerprint.objid ])
											  .select('objid,dtfiled,fingertype,image')
											  .first(); 
		}

		def pc = pcdb.find([ objid: result.clearanceid ]).first(); 		
		result.clearance = pc; 
	} 
}